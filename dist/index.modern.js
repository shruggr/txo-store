import{OP as t,Utils as e,Transaction as s,MerklePath as o}from"@bsv/sdk";import{openDB as n}from"@tempfix/idb";import{Buffer as r}from"buffer";function i(t){var e,s,o,n=2;for("undefined"!=typeof Symbol&&(s=Symbol.asyncIterator,o=Symbol.iterator);n--;){if(s&&null!=(e=t[s]))return e.call(t);if(o&&null!=(e=t[o]))return new a(e.call(t));s="@@asyncIterator",o="@@iterator"}throw new TypeError("Object is not async iterable")}function a(t){function e(t){if(Object(t)!==t)return Promise.reject(new TypeError(t+" is not an object."));var e=t.done;return Promise.resolve(t.value).then(function(t){return{value:t,done:e}})}return a=function(t){this.s=t,this.n=t.next},a.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(t){var s=this.s.return;return void 0===s?Promise.resolve({value:t,done:!0}):e(s.apply(this.s,arguments))},throw:function(t){var s=this.s.return;return void 0===s?Promise.reject(t):e(s.apply(this.s,arguments))}},new a(t)}function h(){return h=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var s=arguments[e];for(var o in s)({}).hasOwnProperty.call(s,o)&&(t[o]=s[o])}return t},h.apply(null,arguments)}class c{constructor(t=Date.now(),e=0n,s=""){this.height=void 0,this.idx=void 0,this.hash=void 0,this.height=t,this.idx=e,this.hash=s}toJSON(){return{height:this.height,idx:this.idx.toString(),hash:this.hash}}}class l{constructor(t,e,s){this.txid=void 0,this.vin=void 0,this.block=void 0,this.txid=t,this.vin=e,this.block=s}toJSON(){var t;return{txid:this.txid,vin:this.vin,block:null==(t=this.block)?void 0:t.toJSON()}}}class d{constructor(t,e,s,o){this.txid=void 0,this.vout=void 0,this.satoshis=void 0,this.script=void 0,this.block=void 0,this.spend=void 0,this.data={},this.events=[],this.owner="",this.txid=t,this.vout=e,this.satoshis=s,this.script=o}static fromObject(t,e=[]){const s=new d(t.txid,t.vout,t.satoshis,t.script);s.block=t.block&&new c(t.block.height,t.block.idx,t.block.hash),s.spend=t.spend&&new l(t.spend.txid,t.spend.vin,t.spend.block&&new c(t.spend.block.height,t.spend.block.idx,t.spend.block.hash)),s.owner=t.owner;for(let o of e)t.data[o.tag]&&(s.data[o.tag]=o.fromObj(t.data[o.tag]));return s.events=t.events,s}toJSON(){return h({},this,{script:r.from(this.script).toString("base64"),satoshis:this.satoshis.toString(),owner:this.owner,data:Object.entries(this.data).reduce((t,[e,s])=>(t[e]=s.data,t),{}),events:this.events})}}var u;!function(t){t[t.INVALID=-1]="INVALID",t[t.PENDING=0]="PENDING",t[t.BROADCASTED=1]="BROADCASTED",t[t.CONFIRMED=2]="CONFIRMED"}(u||(u={}));class f{constructor(){this.db=void 0,this.syncInProgress=!1,this.db=n("blocks",1,{upgrade(t){t.createObjectStore("headers",{keyPath:"height"}).createIndex("byHash","hash")}})}async syncBlocks(){if(this.syncInProgress)return;this.syncInProgress=!0;let t=1;const e=await this.db,s=await e.transaction("headers").store.openCursor(null,"prev");s&&(t=s.key>5?s.key-5:1);try{let s=await fetch(`https://ordinals.gorillapool.io/api/blocks/list/${t}?limit=10000`),o=await s.json();do{console.log("Syncing from",t);const n=e.transaction("headers","readwrite");for(let e of o)n.store.put(e),t=e.height+1;await n.done,s=await fetch(`https://ordinals.gorillapool.io/api/blocks/list/${t}?limit=10000`),o=await s.json()}while(1e4==o.length)}catch(t){console.error(t)}finally{this.syncInProgress=!1,setTimeout(()=>this.syncBlocks(),6e4)}}async isValidRootForHeight(t,e){const s=await this.db,o=await s.get("headers",e);return(null==o?void 0:o.merkleroot)==t}async getHashByHeight(t){var e;const s=await this.db;return null==(e=await s.get("headers",t))?void 0:e.hash}async getHeightByHash(t){var e;const s=await this.db;return null==(e=await s.getFromIndex("headers","byHash",t))?void 0:e.height}}function v(s,o=0){var n,r,i,a,h;return(null==(n=s.chunks[0+o])?void 0:n.op)===t.OP_DUP&&(null==(r=s.chunks[1+o])?void 0:r.op)===t.OP_HASH160&&20===(null==(i=s.chunks[2+o])||null==(i=i.data)?void 0:i.length)&&(null==(a=s.chunks[3+o])?void 0:a.op)===t.OP_EQUALVERIFY&&(null==(h=s.chunks[4+o])?void 0:h.op)===t.OP_CHECKSIG?e.toBase58Check(s.chunks[2+o].data,[0]):""}class w{constructor(t,e=[],s=new Set){this.accountId=void 0,this.indexers=void 0,this.addresses=void 0,this.db=void 0,this.blocks=new f,this.accountId=t,this.indexers=e,this.addresses=s,this.indexers.forEach(t=>t.addresses=this.addresses),this.db=n(`txostore-${t}`,1,{upgrade(t){const e=t.createObjectStore("txos",{keyPath:["txid","vout"]});e.createIndex("events","events",{multiEntry:!0}),e.createIndex("owner","owner"),t.createObjectStore("txns",{keyPath:"txid"})}})}async getTx(t,e=!1){var n;let r=await(await this.db).get("txns",t);if(r){const t=s.fromBinary(Array.from(new Uint8Array(r.rawtx)));return t.merklePath=o.fromBinary(Array.from(r.proof)),t}if(!e)return;console.log("Fetching",t);const[i,a]=await Promise.all([fetch(`https://junglebus.gorillapool.io/v1/transaction/get/${t}/bin`).then(t=>t.arrayBuffer()),fetch(`https://junglebus.gorillapool.io/v1/transaction/proof/${t}`).then(t=>t.arrayBuffer())]),h=s.fromBinary(Array.from(new Uint8Array(i)));return h.merklePath=o.fromBinary(Array.from(new Uint8Array(a))),r={txid:t,rawtx:new Uint8Array(i),proof:new Uint8Array(a),block:new c(h.merklePath.blockHeight,BigInt((null==(n=h.merklePath.path[0].find(e=>e.hash==t))?void 0:n.offset)||0)),status:u.CONFIRMED},await(await this.db).put("txns",r),h}async getTxo(t,e){return(await this.db).get("txos",[t,e])}async searchTxos(t,e=10,s){const o=await this.db;let n=t.toQueryKey();const r=IDBKeyRange.bound(s||n,n+"ï¿¿",!0,!1),a={txos:[]};console.time("findTxos");var h,c=!1,l=!1;try{for(var u,f=i(o.transaction("txos").store.index("events").iterate(r));c=!(u=await f.next()).done;c=!1){const s=u.value;{const o=d.fromObject(s.value,this.indexers);if(a.nextPage=s.key,t.owner&&o.owner!=t.owner)continue;if(a.txos.push(o),console.timeLog("findTxos",o.txid,o.vout),a.txos.length>=e)return console.timeEnd("findTxos"),a}}}catch(t){l=!0,h=t}finally{try{c&&null!=f.return&&await f.return()}finally{if(l)throw h}}return delete a.nextPage,console.timeEnd("findTxos"),a}async ingest(t,e=!1){const s=t.id("hex");let o={height:Date.now(),idx:0n};if(t.merklePath){var n;const e=t.hash("hex"),s=(null==(n=t.merklePath.path[0].find(t=>t.hash==e))?void 0:n.offset)||0;o.height=t.merklePath.blockHeight,o.idx=BigInt(s),o.hash=await this.blocks.getHashByHeight(t.merklePath.blockHeight)||""}const a={txid:s,tx:t,block:o,spends:[],txos:[]};for(const s of t.inputs)if(s.sourceTXID||(s.sourceTXID=s.sourceTransaction.id("hex")),s.sourceTransaction){if(await(await this.db).getKey("txns",s.sourceTXID))continue;await this.ingest(s.sourceTransaction)}else if(s.sourceTransaction=await this.getTx(s.sourceTXID,e),!s.sourceTransaction)throw new Error(`Failed to get source tx ${s.sourceTXID}`);const h=(await this.db).transaction("txos","readwrite");var c,u=!1,f=!1;try{for(var w,p=i(t.inputs.entries());u=!(w=await p.next()).done;u=!1){const[t,e]=w.value;{let n=await h.store.get([e.sourceTXID,e.sourceOutputIndex]);const i=n?d.fromObject(n,this.indexers):new d(e.sourceTXID,e.sourceOutputIndex,BigInt(e.sourceTransaction.outputs[e.sourceOutputIndex].satoshis),r.from(e.sourceTransaction.outputs[e.sourceOutputIndex].lockingScript.toBinary()));i.spend=new l(s,t,o),a.spends.push(i),h.store.put(i)}}}catch(t){f=!0,c=t}finally{try{u&&null!=p.return&&await p.return()}finally{if(f)throw c}}var g,y=!1,x=!1;try{for(var b,k=i(t.outputs.entries());y=!(b=await k.next()).done;y=!1){const[t,e]=b.value;{let n,r=await h.store.get([s,t]);if(r)n=d.fromObject(r);else{const o=e.lockingScript.toBinary();n=new d(s,t,BigInt(e.satoshis),new Uint8Array(o))}n.owner||(n.owner=v(e.lockingScript,0)),n.block=o,n.events=[],a.txos.push(n),this.indexers.forEach(e=>{const s=e.parse&&e.parse(a,t);s&&(n.data[e.tag]=s)})}}}catch(t){x=!0,g=t}finally{try{y&&null!=k.return&&await k.return()}finally{if(x)throw g}}this.indexers.forEach(t=>t.save&&t.save(a));for(const t of a.txos){var m,I;t.events=[];const e=t.spend?"1":"0",s=((null==(m=t.spend)||null==(m=m.block)?void 0:m.height)||(null==(I=t.block)?void 0:I.height)||Date.now()).toString(16).padStart(8,"0");t.owner&&this.addresses.has(t.owner)&&Object.entries(t.data).forEach(([o,n])=>{n.events.forEach(n=>{var r;t.events.push(`${o}:${n.id}:${n.value}:${e}:${s}:${null==(r=t.block)?void 0:r.idx}:${t.vout}:${t.satoshis}`)})}),h.store.put(t)}return await h.done,a}}export{w as TxoStore};
//# sourceMappingURL=index.modern.js.map
