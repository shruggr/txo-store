import{OP as t,Utils as n,Transaction as e,MerklePath as r}from"@bsv/sdk";import{openDB as o}from"@tempfix/idb";import{Buffer as i}from"buffer";function u(t,n){(null==n||n>t.length)&&(n=t.length);for(var e=0,r=Array(n);e<n;e++)r[e]=t[e];return r}function s(t){var n,e,r,o=2;for("undefined"!=typeof Symbol&&(e=Symbol.asyncIterator,r=Symbol.iterator);o--;){if(e&&null!=(n=t[e]))return n.call(t);if(r&&null!=(n=t[r]))return new h(n.call(t));e="@@asyncIterator",r="@@iterator"}throw new TypeError("Object is not async iterable")}function h(t){function n(t){if(Object(t)!==t)return Promise.reject(new TypeError(t+" is not an object."));var n=t.done;return Promise.resolve(t.value).then(function(t){return{value:t,done:n}})}return h=function(t){this.s=t,this.n=t.next},h.prototype={s:null,n:null,next:function(){return n(this.n.apply(this.s,arguments))},return:function(t){var e=this.s.return;return void 0===e?Promise.resolve({value:t,done:!0}):n(e.apply(this.s,arguments))},throw:function(t){var e=this.s.return;return void 0===e?Promise.reject(t):n(e.apply(this.s,arguments))}},new h(t)}function c(t,n){var e="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(e)return(e=e.call(t)).next.bind(e);if(Array.isArray(t)||(e=function(t,n){if(t){if("string"==typeof t)return u(t,n);var e={}.toString.call(t).slice(8,-1);return"Object"===e&&t.constructor&&(e=t.constructor.name),"Map"===e||"Set"===e?Array.from(t):"Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?u(t,n):void 0}}(t))||n&&t&&"number"==typeof t.length){e&&(t=e);var r=0;return function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function a(){return a=Object.assign?Object.assign.bind():function(t){for(var n=1;n<arguments.length;n++){var e=arguments[n];for(var r in e)({}).hasOwnProperty.call(e,r)&&(t[r]=e[r])}return t},a.apply(null,arguments)}var f,l=/*#__PURE__*/function(){function t(t,n,e){void 0===t&&(t=Date.now()),void 0===n&&(n=0n),void 0===e&&(e=""),this.height=void 0,this.idx=void 0,this.hash=void 0,this.height=t,this.idx=n,this.hash=e}return t.prototype.toJSON=function(){return{height:this.height,idx:this.idx.toString(),hash:this.hash}},t}(),v=/*#__PURE__*/function(){function t(t,n,e){this.txid=void 0,this.vin=void 0,this.block=void 0,this.txid=t,this.vin=n,this.block=e}return t.prototype.toJSON=function(){var t;return{txid:this.txid,vin:this.vin,block:null==(t=this.block)?void 0:t.toJSON()}},t}(),d=/*#__PURE__*/function(){function t(t,n,e,r){this.txid=void 0,this.vout=void 0,this.satoshis=void 0,this.script=void 0,this.block=void 0,this.spend=void 0,this.data={},this.events=[],this.owner="",this.txid=t,this.vout=n,this.satoshis=e,this.script=r}return t.fromObject=function(n,e){void 0===e&&(e=[]);var r=new t(n.txid,n.vout,n.satoshis,n.script);r.block=n.block&&new l(n.block.height,n.block.idx,n.block.hash),r.spend=n.spend&&new v(n.spend.txid,n.spend.vin,n.spend.block&&new l(n.spend.block.height,n.spend.block.idx,n.spend.block.hash)),r.owner=n.owner;for(var o,i=c(e);!(o=i()).done;){var u=o.value;n.data[u.tag]&&(r.data[u.tag]=u.fromObj(n.data[u.tag]))}return r.events=n.events,r},t.prototype.toJSON=function(){return a({},this,{script:i.from(this.script).toString("base64"),satoshis:this.satoshis.toString(),owner:this.owner,data:Object.entries(this.data).reduce(function(t,n){return t[n[0]]=n[1].data,t},{}),events:this.events})},t}();function m(t,n,e){if(!t.s){if(e instanceof p){if(!e.s)return void(e.o=m.bind(null,t,n));1&n&&(n=e.s),e=e.v}if(e&&e.then)return void e.then(m.bind(null,t,n),m.bind(null,t,2));t.s=n,t.v=e;var r=t.o;r&&r(t)}}!function(t){t[t.INVALID=-1]="INVALID",t[t.PENDING=0]="PENDING",t[t.BROADCASTED=1]="BROADCASTED",t[t.CONFIRMED=2]="CONFIRMED"}(f||(f={}));var p=/*#__PURE__*/function(){function t(){}return t.prototype.then=function(n,e){var r=new t,o=this.s;if(o){var i=1&o?n:e;if(i){try{m(r,1,i(this.v))}catch(t){m(r,2,t)}return r}return this}return this.o=function(t){try{var o=t.v;1&t.s?m(r,1,n?n(o):o):e?m(r,1,e(o)):m(r,2,o)}catch(t){m(r,2,t)}},r},t}();function b(t){return t instanceof p&&1&t.s}var y=1e4,g=/*#__PURE__*/function(){function t(){this.db=void 0,this.syncInProgress=!1,this.db=o("blocks",1,{upgrade:function(t){t.createObjectStore("headers",{keyPath:"height"}).createIndex("byHash","hash")}})}var n=t.prototype;return n.syncBlocks=function(){try{var t=this;if(t.syncInProgress)return Promise.resolve();t.syncInProgress=!0;var n=1;return Promise.resolve(t.db).then(function(e){return Promise.resolve(e.transaction("headers").store.openCursor(null,"prev")).then(function(r){r&&(n=r.key>5?r.key-5:1);var o=function(t,r){try{var o=function(t,r){try{var o=Promise.resolve(fetch("https://ordinals.gorillapool.io/api/blocks/list/"+n+"?limit="+y)).then(function(t){return Promise.resolve(t.json()).then(function(r){var o=function(t,n){var e;do{var r=t();if(r&&r.then){if(!b(r)){e=!0;break}r=r.v}var o=n();if(b(o)&&(o=o.v),!o)return r}while(!o.then);var i=new p,u=m.bind(null,i,2);return(e?r.then(s):o.then(h)).then(void 0,u),i;function s(e){for(r=e;b(o=n())&&(o=o.v),o;){if(o.then)return void o.then(h).then(void 0,u);if((r=t())&&r.then){if(!b(r))return void r.then(s).then(void 0,u);r=r.v}}m(i,1,r)}function h(e){if(e){do{if((r=t())&&r.then){if(!b(r))return void r.then(s).then(void 0,u);r=r.v}if(b(e=n())&&(e=e.v),!e)return void m(i,1,r)}while(!e.then);e.then(h).then(void 0,u)}else m(i,1,r)}}(function(){console.log("Syncing from",n);for(var o,i=e.transaction("headers","readwrite"),u=c(r);!(o=u()).done;){var s=o.value;i.store.put(s),n=s.height+1}return Promise.resolve(i.done).then(function(){return Promise.resolve(fetch("https://ordinals.gorillapool.io/api/blocks/list/"+n+"?limit="+y)).then(function(n){return t=n,Promise.resolve(t.json()).then(function(t){r=t})})})},function(){return r.length==y});if(o&&o.then)return o.then(function(){})})})}catch(t){return r(t)}return o&&o.then?o.then(void 0,r):o}(0,function(t){console.error(t)})}catch(t){return r(!0,t)}return o&&o.then?o.then(r.bind(null,!1),r.bind(null,!0)):r(!1,o)}(0,function(n,e){if(t.syncInProgress=!1,setTimeout(function(){return t.syncBlocks()},6e4),n)throw e;return e});if(o&&o.then)return o.then(function(){})})})}catch(t){return Promise.reject(t)}},n.isValidRootForHeight=function(t,n){try{return Promise.resolve(this.db).then(function(e){return Promise.resolve(e.get("headers",n)).then(function(n){return(null==n?void 0:n.merkleroot)==t})})}catch(t){return Promise.reject(t)}},n.getHashByHeight=function(t){try{return Promise.resolve(this.db).then(function(n){return Promise.resolve(n.get("headers",t)).then(function(t){return null==t?void 0:t.hash})})}catch(t){return Promise.reject(t)}},n.getHeightByHash=function(t){try{return Promise.resolve(this.db).then(function(n){return Promise.resolve(n.getFromIndex("headers","byHash",t)).then(function(t){return null==t?void 0:t.height})})}catch(t){return Promise.reject(t)}},t}();function x(t,n,e){if(!t.s){if(e instanceof P){if(!e.s)return void(e.o=x.bind(null,t,n));1&n&&(n=e.s),e=e.v}if(e&&e.then)return void e.then(x.bind(null,t,n),x.bind(null,t,2));t.s=n,t.v=e;var r=t.o;r&&r(t)}}const P=/*#__PURE__*/function(){function t(){}return t.prototype.then=function(n,e){const r=new t,o=this.s;if(o){const t=1&o?n:e;if(t){try{x(r,1,t(this.v))}catch(t){x(r,2,t)}return r}return this}return this.o=function(t){try{const o=t.v;1&t.s?x(r,1,n?n(o):o):e?x(r,1,e(o)):x(r,2,o)}catch(t){x(r,2,t)}},r},t}();function w(t){return t instanceof P&&1&t.s}function k(t,n,e){for(var r;;){var o=t();if(w(o)&&(o=o.v),!o)return i;if(o.then){r=0;break}var i=e();if(i&&i.then){if(!w(i)){r=1;break}i=i.s}if(n){var u=n();if(u&&u.then&&!w(u)){r=2;break}}}var s=new P,h=x.bind(null,s,2);return(0===r?o.then(a):1===r?i.then(c):u.then(f)).then(void 0,h),s;function c(r){i=r;do{if(n&&(u=n())&&u.then&&!w(u))return void u.then(f).then(void 0,h);if(!(o=t())||w(o)&&!o.v)return void x(s,1,i);if(o.then)return void o.then(a).then(void 0,h);w(i=e())&&(i=i.v)}while(!i||!i.then);i.then(c).then(void 0,h)}function a(t){t?(i=e())&&i.then?i.then(c).then(void 0,h):c(i):x(s,1,i)}function f(){(o=t())?o.then?o.then(a).then(void 0,h):a(o):x(s,1,i)}}function I(t,n){try{var e=t()}catch(t){return n(t)}return e&&e.then?e.then(void 0,n):e}function O(t,n){try{var e=t()}catch(t){return n(!0,t)}return e&&e.then?e.then(n.bind(null,!1),n.bind(null,!0)):n(!1,e)}var S="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator",j=/*#__PURE__*/function(){function u(t,n,e){var r=this;void 0===n&&(n=[]),void 0===e&&(e=new Set),this.accountId=void 0,this.indexers=void 0,this.addresses=void 0,this.db=void 0,this.blocks=new g,this.accountId=t,this.indexers=n,this.addresses=e,this.indexers.forEach(function(t){return t.addresses=r.addresses}),this.db=o("txostore-"+t,1,{upgrade:function(t){var n=t.createObjectStore("txos",{keyPath:["txid","vout"]});n.createIndex("events","events",{multiEntry:!0}),n.createIndex("owner","owner"),t.createObjectStore("txns",{keyPath:"txid"})}})}var h=u.prototype;return h.getTx=function(t,n){void 0===n&&(n=!1);try{var o=this;return Promise.resolve(o.db).then(function(i){return Promise.resolve(i.get("txns",t)).then(function(i){if(i){var u=e.fromBinary(Array.from(new Uint8Array(i.rawtx)));return u.merklePath=r.fromBinary(Array.from(i.proof)),u}if(n)return console.log("Fetching",t),Promise.resolve(Promise.all([fetch("https://junglebus.gorillapool.io/v1/transaction/get/"+t+"/bin").then(function(t){return t.arrayBuffer()}),fetch("https://junglebus.gorillapool.io/v1/transaction/proof/"+t).then(function(t){return t.arrayBuffer()})])).then(function(n){var u,s=n[0],h=n[1],c=e.fromBinary(Array.from(new Uint8Array(s)));return c.merklePath=r.fromBinary(Array.from(new Uint8Array(h))),i={txid:t,rawtx:new Uint8Array(s),proof:new Uint8Array(h),block:new l(c.merklePath.blockHeight,BigInt((null==(u=c.merklePath.path[0].find(function(n){return n.hash==t}))?void 0:u.offset)||0)),status:f.CONFIRMED},Promise.resolve(o.db).then(function(t){return Promise.resolve(t.put("txns",i)).then(function(){return c})})})})})}catch(t){return Promise.reject(t)}},h.getTxo=function(t,n){try{return Promise.resolve(this.db).then(function(e){return e.get("txos",[t,n])})}catch(t){return Promise.reject(t)}},h.searchTxos=function(t,n,e){void 0===n&&(n=10);try{var r,o,i=this;return Promise.resolve(i.db).then(function(u){var h;function c(t){return h?t:(delete l.nextPage,console.timeEnd("findTxos"),l)}var a=t.toQueryKey(),f=IDBKeyRange.bound(e||a,a+"ï¿¿",!0,!1),l={txos:[]};console.time("findTxos");var v,m=!1,p=!1,b=O(function(){return I(function(){return r=s(u.transaction("txos").store.index("events").iterate(f)),k(function(){function t(t){return!h&&(m=!(o=t).done)}return h?!!t(!h&&r.next()):Promise.resolve(!h&&r.next()).then(t)},function(){return!!(m=!1)},function(){var e=o.value,r=d.fromObject(e.value,i.indexers);if(l.nextPage=e.key,!t.owner||r.owner==t.owner)return l.txos.push(r),console.timeLog("findTxos",r.txid,r.vout),l.txos.length>=n?(console.timeEnd("findTxos"),h=1,l):void 0})},function(t){p=!0,v=t})},function(t,n){function e(e){if(h)return e;if(t)throw n;return n}var o=O(function(){var t=function(){if(m&&null!=r.return)return Promise.resolve(r.return()).then(function(){})}();if(t&&t.then)return t.then(function(){})},function(t,n){if(p)throw v;if(t)throw n;return n});return o&&o.then?o.then(e):e(o)});return b&&b.then?b.then(c):c(b)})}catch(t){return Promise.reject(t)}},h.ingest=function(e,r){void 0===r&&(r=!1);try{var o,u,h,a,f=function(){function f(r){return Promise.resolve(l.db).then(function(r){function f(r){function o(t){l.indexers.forEach(function(t){return t.save&&t.save(b)});for(var n,e=function(){var t,e,r=n.value;r.events=[];var o=r.spend?"1":"0",i=((null==(t=r.spend)||null==(t=t.block)?void 0:t.height)||(null==(e=r.block)?void 0:e.height)||Date.now()).toString(16).padStart(8,"0");r.owner&&l.addresses.has(r.owner)&&Object.entries(r.data).forEach(function(t){var n=t[0];t[1].events.forEach(function(t){var e;r.events.push(n+":"+t.id+":"+t.value+":"+o+":"+i+":"+(null==(e=r.block)?void 0:e.idx)+":"+r.vout+":"+r.satoshis)})}),g.store.put(r)},r=c(b.txos);!(n=r()).done;)e();return Promise.resolve(g.done).then(function(){return b})}var i,u=!1,f=!1,v=O(function(){return I(function(){h=s(e.outputs.entries());var r=k(function(){return Promise.resolve(h.next()).then(function(t){return u=!(a=t).done})},function(){return!!(u=!1)},function(){var e=a.value,r=e[0],o=e[1];return Promise.resolve(g.store.get([m,r])).then(function(e){var i;if(e)i=d.fromObject(e);else{var u=o.lockingScript.toBinary();i=new d(m,r,BigInt(o.satoshis),new Uint8Array(u))}i.owner||(i.owner=function(e,r){var o,i,u,s,h;return void 0===r&&(r=0),(null==(o=e.chunks[0+r])?void 0:o.op)===t.OP_DUP&&(null==(i=e.chunks[1+r])?void 0:i.op)===t.OP_HASH160&&20===(null==(u=e.chunks[2+r])||null==(u=u.data)?void 0:u.length)&&(null==(s=e.chunks[3+r])?void 0:s.op)===t.OP_EQUALVERIFY&&(null==(h=e.chunks[4+r])?void 0:h.op)===t.OP_CHECKSIG?n.toBase58Check(e.chunks[2+r].data,[0]):""}(o.lockingScript,0)),i.block=p,i.events=[],b.txos.push(i),l.indexers.forEach(function(t){var n=t.parse&&t.parse(b,r);n&&(i.data[t.tag]=n)})})});if(r&&r.then)return r.then(function(){})},function(t){f=!0,i=t})},function(t,n){function e(e){if(t)throw n;return n}var r=O(function(){var t=function(){if(u&&null!=h.return)return Promise.resolve(h.return()).then(function(){})}();if(t&&t.then)return t.then(function(){})},function(t,n){if(f)throw i;if(t)throw n;return n});return r&&r.then?r.then(e):e()});return v&&v.then?v.then(o):o()}var y,g=r.transaction("txos","readwrite"),x=!1,P=!1,w=O(function(){return I(function(){o=s(e.inputs.entries());var t=k(function(){return Promise.resolve(o.next()).then(function(t){return x=!(u=t).done})},function(){return!!(x=!1)},function(){var t=u.value,n=t[0],e=t[1];return Promise.resolve(g.store.get([e.sourceTXID,e.sourceOutputIndex])).then(function(t){var r=t?d.fromObject(t,l.indexers):new d(e.sourceTXID,e.sourceOutputIndex,BigInt(e.sourceTransaction.outputs[e.sourceOutputIndex].satoshis),i.from(e.sourceTransaction.outputs[e.sourceOutputIndex].lockingScript.toBinary()));r.spend=new v(m,n,p),b.spends.push(r),g.store.put(r)})});if(t&&t.then)return t.then(function(){})},function(t){P=!0,y=t})},function(t,n){function e(e){if(t)throw n;return n}var r=O(function(){var t=function(){if(x&&null!=o.return)return Promise.resolve(o.return()).then(function(){})}();if(t&&t.then)return t.then(function(){})},function(t,n){if(P)throw y;if(t)throw n;return n});return r&&r.then?r.then(e):e()});return w&&w.then?w.then(f):f()})}var b={txid:m,tx:e,block:p,spends:[],txos:[]},y=function(t,n,e){if("function"==typeof t[S]){var r,o,i,u=t[S]();if(function t(e){try{for(;!(r=u.next()).done;)if((e=n(r.value))&&e.then){if(!w(e))return void e.then(t,i||(i=x.bind(null,o=new P,2)));e=e.v}o?x(o,1,e):o=e}catch(t){x(o||(o=new P),2,t)}}(),u.return){var s=function(t){try{r.done||u.return()}catch(t){}return t};if(o&&o.then)return o.then(s,function(t){throw s(t)});s()}return o}if(!("length"in t))throw new TypeError("Object is not iterable");for(var h=[],c=0;c<t.length;c++)h.push(t[c]);return function(t,n,e){var r,o,i=-1;return function e(u){try{for(;++i<t.length;)if((u=n(i))&&u.then){if(!w(u))return void u.then(e,o||(o=x.bind(null,r=new P,2)));u=u.v}r?x(r,1,u):r=u}catch(t){x(r||(r=new P),2,t)}}(),r}(h,function(t){return n(h[t])})}(e.inputs,function(t){return t.sourceTXID||(t.sourceTXID=t.sourceTransaction.id("hex")),t.sourceTransaction?Promise.resolve(l.db).then(function(n){return Promise.resolve(n.getKey("txns",t.sourceTXID)).then(function(n){if(!n)return Promise.resolve(l.ingest(t.sourceTransaction)).then(function(){})})}):Promise.resolve(l.getTx(t.sourceTXID,r)).then(function(n){if(t.sourceTransaction=n,!t.sourceTransaction)throw new Error("Failed to get source tx "+t.sourceTXID)})});return y&&y.then?y.then(f):f()},l=this,m=e.id("hex"),p={height:Date.now(),idx:0n},b=function(){if(e.merklePath){var t,n=e.hash("hex"),r=(null==(t=e.merklePath.path[0].find(function(t){return t.hash==n}))?void 0:t.offset)||0;return p.height=e.merklePath.blockHeight,p.idx=BigInt(r),Promise.resolve(l.blocks.getHashByHeight(e.merklePath.blockHeight)).then(function(t){p.hash=t||""})}}();return Promise.resolve(b&&b.then?b.then(f):f())}catch(t){return Promise.reject(t)}},u}();export{j as TxoStore};
//# sourceMappingURL=index.module.js.map
