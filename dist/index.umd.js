!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("@bsv/sdk"),require("@tempfix/idb"),require("buffer")):"function"==typeof define&&define.amd?define(["exports","@bsv/sdk","@tempfix/idb","buffer"],n):n((t||self).txoStore={},t.sdk,t.idb,t.buffer)}(this,function(t,n,e,r){function o(t,n){(null==n||n>t.length)&&(n=t.length);for(var e=0,r=Array(n);e<n;e++)r[e]=t[e];return r}function i(t){var n,e,r,o=2;for("undefined"!=typeof Symbol&&(e=Symbol.asyncIterator,r=Symbol.iterator);o--;){if(e&&null!=(n=t[e]))return n.call(t);if(r&&null!=(n=t[r]))return new u(n.call(t));e="@@asyncIterator",r="@@iterator"}throw new TypeError("Object is not async iterable")}function u(t){function n(t){if(Object(t)!==t)return Promise.reject(new TypeError(t+" is not an object."));var n=t.done;return Promise.resolve(t.value).then(function(t){return{value:t,done:n}})}return u=function(t){this.s=t,this.n=t.next},u.prototype={s:null,n:null,next:function(){return n(this.n.apply(this.s,arguments))},return:function(t){var e=this.s.return;return void 0===e?Promise.resolve({value:t,done:!0}):n(e.apply(this.s,arguments))},throw:function(t){var e=this.s.return;return void 0===e?Promise.reject(t):n(e.apply(this.s,arguments))}},new u(t)}function s(t,n){var e="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(e)return(e=e.call(t)).next.bind(e);if(Array.isArray(t)||(e=function(t,n){if(t){if("string"==typeof t)return o(t,n);var e={}.toString.call(t).slice(8,-1);return"Object"===e&&t.constructor&&(e=t.constructor.name),"Map"===e||"Set"===e?Array.from(t):"Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?o(t,n):void 0}}(t))||n&&t&&"number"==typeof t.length){e&&(t=e);var r=0;return function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function h(){return h=Object.assign?Object.assign.bind():function(t){for(var n=1;n<arguments.length;n++){var e=arguments[n];for(var r in e)({}).hasOwnProperty.call(e,r)&&(t[r]=e[r])}return t},h.apply(null,arguments)}var c,a=/*#__PURE__*/function(){function t(t,n,e){void 0===t&&(t=Date.now()),void 0===n&&(n=0n),void 0===e&&(e=""),this.height=void 0,this.idx=void 0,this.hash=void 0,this.height=t,this.idx=n,this.hash=e}return t.prototype.toJSON=function(){return{height:this.height,idx:this.idx.toString(),hash:this.hash}},t}(),f=/*#__PURE__*/function(){function t(t,n,e){this.txid=void 0,this.vin=void 0,this.block=void 0,this.txid=t,this.vin=n,this.block=e}return t.prototype.toJSON=function(){var t;return{txid:this.txid,vin:this.vin,block:null==(t=this.block)?void 0:t.toJSON()}},t}(),l=/*#__PURE__*/function(){function t(t,n,e,r){this.txid=void 0,this.vout=void 0,this.satoshis=void 0,this.script=void 0,this.block=void 0,this.spend=void 0,this.data={},this.events=[],this.owner="",this.txid=t,this.vout=n,this.satoshis=e,this.script=r}return t.fromObject=function(n,e){void 0===e&&(e=[]);var r=new t(n.txid,n.vout,n.satoshis,n.script);r.block=n.block&&new a(n.block.height,n.block.idx,n.block.hash),r.spend=n.spend&&new f(n.spend.txid,n.spend.vin,n.spend.block&&new a(n.spend.block.height,n.spend.block.idx,n.spend.block.hash)),r.owner=n.owner;for(var o,i=s(e);!(o=i()).done;){var u=o.value;n.data[u.tag]&&(r.data[u.tag]=u.fromObj(n.data[u.tag]))}return r.events=n.events,r},t.prototype.toJSON=function(){return h({},this,{script:r.Buffer.from(this.script).toString("base64"),satoshis:this.satoshis.toString(),owner:this.owner,data:Object.entries(this.data).reduce(function(t,n){return t[n[0]]=n[1].data,t},{}),events:this.events})},t}();function v(t,n,e){if(!t.s){if(e instanceof d){if(!e.s)return void(e.o=v.bind(null,t,n));1&n&&(n=e.s),e=e.v}if(e&&e.then)return void e.then(v.bind(null,t,n),v.bind(null,t,2));t.s=n,t.v=e;var r=t.o;r&&r(t)}}!function(t){t[t.INVALID=-1]="INVALID",t[t.PENDING=0]="PENDING",t[t.BROADCASTED=1]="BROADCASTED",t[t.CONFIRMED=2]="CONFIRMED"}(c||(c={}));var d=/*#__PURE__*/function(){function t(){}return t.prototype.then=function(n,e){var r=new t,o=this.s;if(o){var i=1&o?n:e;if(i){try{v(r,1,i(this.v))}catch(t){v(r,2,t)}return r}return this}return this.o=function(t){try{var o=t.v;1&t.s?v(r,1,n?n(o):o):e?v(r,1,e(o)):v(r,2,o)}catch(t){v(r,2,t)}},r},t}();function b(t){return t instanceof d&&1&t.s}var p=1e4,m=/*#__PURE__*/function(){function t(){this.db=void 0,this.syncInProgress=!1,this.db=e.openDB("blocks",1,{upgrade:function(t){t.createObjectStore("headers",{keyPath:"height"}).createIndex("byHash","hash")}})}var n=t.prototype;return n.syncBlocks=function(){try{var t=this;if(t.syncInProgress)return Promise.resolve();t.syncInProgress=!0;var n=1;return Promise.resolve(t.db).then(function(e){return Promise.resolve(e.transaction("headers").store.openCursor(null,"prev")).then(function(r){r&&(n=r.key>5?r.key-5:1);var o=function(t,r){try{var o=function(t,r){try{var o=Promise.resolve(fetch("https://ordinals.gorillapool.io/api/blocks/list/"+n+"?limit="+p)).then(function(t){return Promise.resolve(t.json()).then(function(r){var o=function(t,n){var e;do{var r=t();if(r&&r.then){if(!b(r)){e=!0;break}r=r.v}var o=n();if(b(o)&&(o=o.v),!o)return r}while(!o.then);var i=new d,u=v.bind(null,i,2);return(e?r.then(s):o.then(h)).then(void 0,u),i;function s(e){for(r=e;b(o=n())&&(o=o.v),o;){if(o.then)return void o.then(h).then(void 0,u);if((r=t())&&r.then){if(!b(r))return void r.then(s).then(void 0,u);r=r.v}}v(i,1,r)}function h(e){if(e){do{if((r=t())&&r.then){if(!b(r))return void r.then(s).then(void 0,u);r=r.v}if(b(e=n())&&(e=e.v),!e)return void v(i,1,r)}while(!e.then);e.then(h).then(void 0,u)}else v(i,1,r)}}(function(){console.log("Syncing from",n);for(var o,i=e.transaction("headers","readwrite"),u=s(r);!(o=u()).done;){var h=o.value;i.store.put(h),n=h.height+1}return Promise.resolve(i.done).then(function(){return Promise.resolve(fetch("https://ordinals.gorillapool.io/api/blocks/list/"+n+"?limit="+p)).then(function(n){return t=n,Promise.resolve(t.json()).then(function(t){r=t})})})},function(){return r.length==p});if(o&&o.then)return o.then(function(){})})})}catch(t){return r(t)}return o&&o.then?o.then(void 0,r):o}(0,function(t){console.error(t)})}catch(t){return r(!0,t)}return o&&o.then?o.then(r.bind(null,!1),r.bind(null,!0)):r(!1,o)}(0,function(n,e){if(t.syncInProgress=!1,setTimeout(function(){return t.syncBlocks()},6e4),n)throw e;return e});if(o&&o.then)return o.then(function(){})})})}catch(t){return Promise.reject(t)}},n.isValidRootForHeight=function(t,n){try{return Promise.resolve(this.db).then(function(e){return Promise.resolve(e.get("headers",n)).then(function(n){return(null==n?void 0:n.merkleroot)==t})})}catch(t){return Promise.reject(t)}},n.getHashByHeight=function(t){try{return Promise.resolve(this.db).then(function(n){return Promise.resolve(n.get("headers",t)).then(function(t){return null==t?void 0:t.hash})})}catch(t){return Promise.reject(t)}},n.getHeightByHash=function(t){try{return Promise.resolve(this.db).then(function(n){return Promise.resolve(n.getFromIndex("headers","byHash",t)).then(function(t){return null==t?void 0:t.height})})}catch(t){return Promise.reject(t)}},t}();function y(t,n,e){if(!t.s){if(e instanceof g){if(!e.s)return void(e.o=y.bind(null,t,n));1&n&&(n=e.s),e=e.v}if(e&&e.then)return void e.then(y.bind(null,t,n),y.bind(null,t,2));t.s=n,t.v=e;var r=t.o;r&&r(t)}}const g=/*#__PURE__*/function(){function t(){}return t.prototype.then=function(n,e){const r=new t,o=this.s;if(o){const t=1&o?n:e;if(t){try{y(r,1,t(this.v))}catch(t){y(r,2,t)}return r}return this}return this.o=function(t){try{const o=t.v;1&t.s?y(r,1,n?n(o):o):e?y(r,1,e(o)):y(r,2,o)}catch(t){y(r,2,t)}},r},t}();function x(t){return t instanceof g&&1&t.s}function P(t,n,e){for(var r;;){var o=t();if(x(o)&&(o=o.v),!o)return i;if(o.then){r=0;break}var i=e();if(i&&i.then){if(!x(i)){r=1;break}i=i.s}if(n){var u=n();if(u&&u.then&&!x(u)){r=2;break}}}var s=new g,h=y.bind(null,s,2);return(0===r?o.then(a):1===r?i.then(c):u.then(f)).then(void 0,h),s;function c(r){i=r;do{if(n&&(u=n())&&u.then&&!x(u))return void u.then(f).then(void 0,h);if(!(o=t())||x(o)&&!o.v)return void y(s,1,i);if(o.then)return void o.then(a).then(void 0,h);x(i=e())&&(i=i.v)}while(!i||!i.then);i.then(c).then(void 0,h)}function a(t){t?(i=e())&&i.then?i.then(c).then(void 0,h):c(i):y(s,1,i)}function f(){(o=t())?o.then?o.then(a).then(void 0,h):a(o):y(s,1,i)}}function w(t,n){try{var e=t()}catch(t){return n(t)}return e&&e.then?e.then(void 0,n):e}function k(t,n){try{var e=t()}catch(t){return n(!0,t)}return e&&e.then?e.then(n.bind(null,!1),n.bind(null,!0)):n(!1,e)}var I="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";t.TxoStore=/*#__PURE__*/function(){function t(t,n,r){var o=this;void 0===n&&(n=[]),void 0===r&&(r=new Set),this.accountId=void 0,this.indexers=void 0,this.addresses=void 0,this.db=void 0,this.blocks=new m,this.accountId=t,this.indexers=n,this.addresses=r,this.indexers.forEach(function(t){return t.addresses=o.addresses}),this.db=e.openDB("txostore-"+t,1,{upgrade:function(t){var n=t.createObjectStore("txos",{keyPath:["txid","vout"]});n.createIndex("events","events",{multiEntry:!0}),n.createIndex("owner","owner"),t.createObjectStore("txns",{keyPath:"txid"})}})}var o=t.prototype;return o.getTx=function(t,e){void 0===e&&(e=!1);try{var r=this;return Promise.resolve(r.db).then(function(o){return Promise.resolve(o.get("txns",t)).then(function(o){if(o){var i=n.Transaction.fromBinary(Array.from(new Uint8Array(o.rawtx)));return i.merklePath=n.MerklePath.fromBinary(Array.from(o.proof)),i}if(e)return console.log("Fetching",t),Promise.resolve(Promise.all([fetch("https://junglebus.gorillapool.io/v1/transaction/get/"+t+"/bin").then(function(t){return t.arrayBuffer()}),fetch("https://junglebus.gorillapool.io/v1/transaction/proof/"+t).then(function(t){return t.arrayBuffer()})])).then(function(e){var i,u=e[0],s=e[1],h=n.Transaction.fromBinary(Array.from(new Uint8Array(u)));return h.merklePath=n.MerklePath.fromBinary(Array.from(new Uint8Array(s))),o={txid:t,rawtx:new Uint8Array(u),proof:new Uint8Array(s),block:new a(h.merklePath.blockHeight,BigInt((null==(i=h.merklePath.path[0].find(function(n){return n.hash==t}))?void 0:i.offset)||0)),status:c.CONFIRMED},Promise.resolve(r.db).then(function(t){return Promise.resolve(t.put("txns",o)).then(function(){return h})})})})})}catch(t){return Promise.reject(t)}},o.getTxo=function(t,n){try{return Promise.resolve(this.db).then(function(e){return e.get("txos",[t,n])})}catch(t){return Promise.reject(t)}},o.searchTxos=function(t,n,e){void 0===n&&(n=10);try{var r,o,u=this;return Promise.resolve(u.db).then(function(s){var h;function c(t){return h?t:(delete v.nextPage,console.timeEnd("findTxos"),v)}var a=t.toQueryKey(),f=IDBKeyRange.bound(e||a,a+"￿",!0,!1),v={txos:[]};console.time("findTxos");var d,b=!1,p=!1,m=k(function(){return w(function(){return r=i(s.transaction("txos").store.index("events").iterate(f)),P(function(){function t(t){return!h&&(b=!(o=t).done)}return h?!!t(!h&&r.next()):Promise.resolve(!h&&r.next()).then(t)},function(){return!!(b=!1)},function(){var e=o.value,r=l.fromObject(e.value,u.indexers);if(v.nextPage=e.key,!t.owner||r.owner==t.owner)return v.txos.push(r),console.timeLog("findTxos",r.txid,r.vout),v.txos.length>=n?(console.timeEnd("findTxos"),h=1,v):void 0})},function(t){p=!0,d=t})},function(t,n){function e(e){if(h)return e;if(t)throw n;return n}var o=k(function(){var t=function(){if(b&&null!=r.return)return Promise.resolve(r.return()).then(function(){})}();if(t&&t.then)return t.then(function(){})},function(t,n){if(p)throw d;if(t)throw n;return n});return o&&o.then?o.then(e):e(o)});return m&&m.then?m.then(c):c(m)})}catch(t){return Promise.reject(t)}},o.ingest=function(t,e){void 0===e&&(e=!1);try{var o,u,h,c,a=function(){function a(e){return Promise.resolve(v.db).then(function(e){function a(e){function r(t){v.indexers.forEach(function(t){return t.save&&t.save(p)});for(var n,e=function(){var t,e,r=n.value;r.events=[];var o=r.spend?"1":"0",i=((null==(t=r.spend)||null==(t=t.block)?void 0:t.height)||(null==(e=r.block)?void 0:e.height)||Date.now()).toString(16).padStart(8,"0");r.owner&&v.addresses.has(r.owner)&&Object.entries(r.data).forEach(function(t){var n=t[0];t[1].events.forEach(function(t){var e;r.events.push(n+":"+t.id+":"+t.value+":"+o+":"+i+":"+(null==(e=r.block)?void 0:e.idx)+":"+r.vout+":"+r.satoshis)})}),y.store.put(r)},r=s(p.txos);!(n=r()).done;)e();return Promise.resolve(y.done).then(function(){return p})}var o,u=!1,a=!1,f=k(function(){return w(function(){h=i(t.outputs.entries());var e=P(function(){return Promise.resolve(h.next()).then(function(t){return u=!(c=t).done})},function(){return!!(u=!1)},function(){var t=c.value,e=t[0],r=t[1];return Promise.resolve(y.store.get([d,e])).then(function(t){var o;if(t)o=l.fromObject(t);else{var i=r.lockingScript.toBinary();o=new l(d,e,BigInt(r.satoshis),new Uint8Array(i))}o.owner||(o.owner=function(t,e){var r,o,i,u,s;return void 0===e&&(e=0),(null==(r=t.chunks[0+e])?void 0:r.op)===n.OP.OP_DUP&&(null==(o=t.chunks[1+e])?void 0:o.op)===n.OP.OP_HASH160&&20===(null==(i=t.chunks[2+e])||null==(i=i.data)?void 0:i.length)&&(null==(u=t.chunks[3+e])?void 0:u.op)===n.OP.OP_EQUALVERIFY&&(null==(s=t.chunks[4+e])?void 0:s.op)===n.OP.OP_CHECKSIG?n.Utils.toBase58Check(t.chunks[2+e].data,[0]):""}(r.lockingScript,0)),o.block=b,o.events=[],p.txos.push(o),v.indexers.forEach(function(t){var n=t.parse&&t.parse(p,e);n&&(o.data[t.tag]=n)})})});if(e&&e.then)return e.then(function(){})},function(t){a=!0,o=t})},function(t,n){function e(e){if(t)throw n;return n}var r=k(function(){var t=function(){if(u&&null!=h.return)return Promise.resolve(h.return()).then(function(){})}();if(t&&t.then)return t.then(function(){})},function(t,n){if(a)throw o;if(t)throw n;return n});return r&&r.then?r.then(e):e()});return f&&f.then?f.then(r):r()}var m,y=e.transaction("txos","readwrite"),g=!1,x=!1,I=k(function(){return w(function(){o=i(t.inputs.entries());var n=P(function(){return Promise.resolve(o.next()).then(function(t){return g=!(u=t).done})},function(){return!!(g=!1)},function(){var t=u.value,n=t[0],e=t[1];return Promise.resolve(y.store.get([e.sourceTXID,e.sourceOutputIndex])).then(function(t){var o=t?l.fromObject(t,v.indexers):new l(e.sourceTXID,e.sourceOutputIndex,BigInt(e.sourceTransaction.outputs[e.sourceOutputIndex].satoshis),r.Buffer.from(e.sourceTransaction.outputs[e.sourceOutputIndex].lockingScript.toBinary()));o.spend=new f(d,n,b),p.spends.push(o),y.store.put(o)})});if(n&&n.then)return n.then(function(){})},function(t){x=!0,m=t})},function(t,n){function e(e){if(t)throw n;return n}var r=k(function(){var t=function(){if(g&&null!=o.return)return Promise.resolve(o.return()).then(function(){})}();if(t&&t.then)return t.then(function(){})},function(t,n){if(x)throw m;if(t)throw n;return n});return r&&r.then?r.then(e):e()});return I&&I.then?I.then(a):a()})}var p={txid:d,tx:t,block:b,spends:[],txos:[]},m=function(t,n,e){if("function"==typeof t[I]){var r,o,i,u=t[I]();if(function t(e){try{for(;!(r=u.next()).done;)if((e=n(r.value))&&e.then){if(!x(e))return void e.then(t,i||(i=y.bind(null,o=new g,2)));e=e.v}o?y(o,1,e):o=e}catch(t){y(o||(o=new g),2,t)}}(),u.return){var s=function(t){try{r.done||u.return()}catch(t){}return t};if(o&&o.then)return o.then(s,function(t){throw s(t)});s()}return o}if(!("length"in t))throw new TypeError("Object is not iterable");for(var h=[],c=0;c<t.length;c++)h.push(t[c]);return function(t,n,e){var r,o,i=-1;return function e(u){try{for(;++i<t.length;)if((u=n(i))&&u.then){if(!x(u))return void u.then(e,o||(o=y.bind(null,r=new g,2)));u=u.v}r?y(r,1,u):r=u}catch(t){y(r||(r=new g),2,t)}}(),r}(h,function(t){return n(h[t])})}(t.inputs,function(t){return t.sourceTXID||(t.sourceTXID=t.sourceTransaction.id("hex")),t.sourceTransaction?Promise.resolve(v.db).then(function(n){return Promise.resolve(n.getKey("txns",t.sourceTXID)).then(function(n){if(!n)return Promise.resolve(v.ingest(t.sourceTransaction)).then(function(){})})}):Promise.resolve(v.getTx(t.sourceTXID,e)).then(function(n){if(t.sourceTransaction=n,!t.sourceTransaction)throw new Error("Failed to get source tx "+t.sourceTXID)})});return m&&m.then?m.then(a):a()},v=this,d=t.id("hex"),b={height:Date.now(),idx:0n},p=function(){if(t.merklePath){var n,e=t.hash("hex"),r=(null==(n=t.merklePath.path[0].find(function(t){return t.hash==e}))?void 0:n.offset)||0;return b.height=t.merklePath.blockHeight,b.idx=BigInt(r),Promise.resolve(v.blocks.getHashByHeight(t.merklePath.blockHeight)).then(function(t){b.hash=t||""})}}();return Promise.resolve(p&&p.then?p.then(a):a())}catch(t){return Promise.reject(t)}},t}()});
//# sourceMappingURL=index.umd.js.map
